# セキュリティ ガイド

## 認証フローについて

このアプリケーションは **Authorization Code Flow** を使用しており、以下のセキュリティ上の利点があります：

### ✅ セキュリティの向上点

1. **パスワード不要**: ユーザーのパスワードを直接扱わない
2. **ブラウザ認証**: Microsoft の公式ログインページでの認証
3. **トークンキャッシュ**: 認証済みトークンの安全な保存と再利用
4. **自動リフレッシュ**: トークンの自動更新機能
5. **MFA対応**: 多要素認証（MFA）が有効でも動作

### 🔐 認証フロー

1. アプリケーション起動時にブラウザが開く
2. Microsoft ログインページで認証
3. トークンがローカルファイルに安全に保存
4. 次回起動時はキャッシュされたトークンを使用

### 📁 トークン保存

- **保存場所**: `./data/token-cache.json`
- **暗号化**: MSALによる自動暗号化
- **有効期限**: 自動管理とリフレッシュ

## Azure AD 設定要件

### 必須設定

1. **アプリ登録の作成**
   ```
   Azure Portal > Azure Active Directory > アプリの登録 > 新規登録
   ```

2. **リダイレクト URI の設定**
   ```
   認証 > プラットフォームの追加 > Web
   リダイレクト URI: http://localhost:3000/auth/callback
   ```

3. **API 権限の付与**
   ```
   APIのアクセス許可 > アクセス許可の追加
   - Microsoft Graph > 委任されたアクセス許可
   - Mail.Read
   - User.Read
   ```

4. **パブリック クライアント フローの有効化**
   ```
   認証 > 詳細設定 > パブリック クライアント フローを許可する: はい
   ```

5. **管理者の同意**
   ```
   APIのアクセス許可 > <テナント名> に管理者の同意を与えます
   ```

## セキュリティのベストプラクティス

### 🔒 本番環境での推奨事項

1. **ネットワークセキュリティ**
   - ファイアウォール設定の確認
   - 不要なポート（3000）への外部アクセス制限

2. **ファイル権限**
   ```bash
   chmod 600 ./data/token-cache.json
   ```

3. **環境変数の保護**
   ```bash
   chmod 600 .env
   ```

4. **ログ監視**
   - 不正なアクセス試行の監視
   - 認証失敗の記録

### ⚠️ 注意事項

1. **CLIENT_SECRET不要**
   - Public Client Application のため、Client Secret は使用しません

2. **localhost制限**
   - 認証コールバックは localhost:3000 に制限されています

3. **トークン管理**
   - トークンファイルは `.gitignore` に含まれています
   - 定期的なトークンローテーション

## トラブルシューティング

### 認証エラー

- **エラー**: `AADSTS70011: The provided value for the 'redirect_uri' parameter is not valid`
  - **解決**: Azure AD でリダイレクト URI が正しく設定されているか確認

- **エラー**: `AADSTS65001: The user or administrator has not consented`  
  - **解決**: 管理者による同意が必要

- **エラー**: `AADSTS50020: User account from identity provider does not exist`
  - **解決**: 正しいテナントでログインしているか確認

### ポートエラー

- **エラー**: `EADDRINUSE: address already in use :::3000`
  - **解決**: ポート3000を使用している他のプロセスを停止

## 監査とコンプライアンス

### ログ記録

- 認証成功/失敗の記録
- アクセス対象メールボックスの記録  
- API呼び出しの記録

### データ保護

- メール内容は一時的にのみメモリに保存
- 個人情報は適切に処理・削除
- GDPR準拠のデータ処理

このセキュリティガイドに従うことで、安全にアプリケーションを運用できます。